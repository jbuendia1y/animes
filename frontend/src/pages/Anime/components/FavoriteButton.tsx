import {
  Box,
  IconButton,
  Popover,
  Rating,
  Skeleton,
  Typography,
} from "@mui/material";
import { MouseEvent, useEffect, useState } from "react";
import { FavoritesService } from "../../../services/favorites.service";
import { useAuth } from "../../../hooks";
import { CreateFavorite, UpdateFavorite } from "../../../models/favorite.model";
import { UserNotLogged } from "../../../contexts/auth";

export function FavoriteButton({ animeId }: { animeId?: string }) {
  const { user } = useAuth();
  const [anchorEl, setAnchorEl] = useState<HTMLButtonElement | null>(null);

  const [{ stars, favoriteId, isFavorite, loading }, setIsFavorite] = useState({
    stars: 0,
    favoriteId: "",
    isFavorite: false,
    loading: true,
  });

  useEffect(() => {
    if (user === UserNotLogged) {
      setIsFavorite({
        stars: 0,
        favoriteId: "",
        isFavorite: false,
        loading: false,
      });
      return;
    }

    if (!user || !animeId) return;
    let subscribe = true;
    const repository = new FavoritesService();
    repository.find({ animeId }).then((v) => {
      if (v.values.data.length === 0) {
        setIsFavorite({
          stars: 0,
          favoriteId: "",
          isFavorite: false,
          loading: false,
        });
      } else if (subscribe)
        setIsFavorite({
          stars: v.values.data[0].values.stars,
          favoriteId: v.values.data[0].values.id,
          isFavorite: true,
          loading: false,
        });
    });
    return () => {
      subscribe = false;
    };
  }, [user, animeId]);

  const handleValue = async (value: number | null) => {
    if (loading || !user || !animeId) return;

    const repository = new FavoritesService();
    if (isFavorite && value === null) {
      await repository.delete(favoriteId);
      setIsFavorite((v) => ({ ...v, isFavorite: false }));
    }

    if (isFavorite && value) {
      await repository.update(favoriteId, new UpdateFavorite({ stars: value }));
    }
    if (!isFavorite && value)
      await repository.save(new CreateFavorite({ stars: value, animeId }));
  };

  const handleClick = (event: MouseEvent<HTMLButtonElement>) => {
    setAnchorEl(event.currentTarget);
  };

  const handleClose = () => {
    setAnchorEl(null);
  };

  if (loading)
    return (
      <Skeleton variant="circular">
        <IconButton>
          <svg
            width="20"
            height="20"
            viewBox="0 0 26 26"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M10.6853 6.23481L10.6853 6.23486L10.3437 6.84718C10.3275 6.87628 10.3115 6.905 10.2958 6.93334C9.96807 7.52226 9.73192 7.94666 9.35554 8.23298L9.35486 8.2335C8.97414 8.52208 8.50864 8.62697 7.87093 8.77067C7.84063 8.7775 7.80994 8.78441 7.77885 8.79144C7.7788 8.79145 7.77874 8.79147 7.77868 8.79148L7.11635 8.94144L7.11617 8.94148C5.81803 9.23488 4.90268 9.4435 4.26835 9.69356C3.64362 9.93983 3.42018 10.1772 3.33446 10.4522C3.24749 10.7327 3.29794 11.0721 3.66881 11.6613C4.04315 12.256 4.66842 12.9892 5.55252 14.0225L5.55276 14.0228L6.00451 14.5515C6.00462 14.5517 6.00473 14.5518 6.00484 14.5519C6.00484 14.5519 6.00485 14.5519 6.00485 14.5519C6.02561 14.5762 6.0461 14.6001 6.06634 14.6237C6.50208 15.132 6.81572 15.4979 6.95736 15.9574C7.10029 16.4139 7.05316 16.8981 6.98683 17.5796C6.98378 17.611 6.98069 17.6427 6.97757 17.6749L6.97753 17.6753L6.90883 18.379C6.90882 18.3791 6.90881 18.3792 6.9088 18.3793C6.77548 19.7583 6.68189 20.7377 6.71378 21.4509C6.74562 22.163 6.89851 22.4619 7.11651 22.6273C7.32511 22.7854 7.6261 22.8452 8.27362 22.6596C8.92742 22.4722 9.78564 22.0788 11.001 21.5194C11.001 21.5194 11.001 21.5194 11.0011 21.5194L11.6205 21.2341C11.6489 21.221 11.6769 21.2081 11.7046 21.1953C12.3021 20.9194 12.7396 20.7173 13.2143 20.7173C13.6896 20.7173 14.1274 20.9198 14.7251 21.1963C14.7521 21.2087 14.7793 21.2213 14.8069 21.2341C14.807 21.2341 14.8071 21.2342 14.8072 21.2342L15.428 21.5191L15.4286 21.5194C16.6436 22.0789 17.5014 22.4725 18.1552 22.6599C18.8025 22.8454 19.1036 22.7854 19.3128 22.6265L19.3132 22.6262C19.5304 22.4615 19.6832 22.1631 19.7149 21.4508C19.7467 20.7378 19.6531 19.7583 19.5198 18.3794L10.6853 6.23481ZM10.6853 6.23481C11.3534 5.03682 11.8278 4.18854 12.2534 3.63279C12.6788 3.07741 12.9608 2.94128 13.2143 2.94128C13.4677 2.94128 13.7498 3.07741 14.1751 3.63279C14.6007 4.18854 15.0751 5.03682 15.7432 6.23481L15.7432 6.23486L16.0848 6.84718C16.0848 6.84724 16.0849 6.8473 16.0849 6.84736C16.1011 6.8764 16.117 6.90506 16.1328 6.93334C16.4605 7.52226 16.6966 7.94666 17.073 8.23298C17.4528 8.52191 17.9197 8.62695 18.557 8.77033C18.5878 8.77727 18.6191 8.7843 18.6507 8.79144C18.6508 8.79144 18.6508 8.79145 18.6508 8.79145C18.6509 8.79147 18.651 8.79149 18.6511 8.79151L19.3132 8.94144C20.6115 9.2354 21.5266 9.44399 22.1607 9.69395C22.7851 9.94007 23.0083 10.1771 23.0941 10.4521C23.181 10.732 23.1308 11.071 22.7597 11.6605C22.3854 12.2553 21.7601 12.9887 20.8759 14.0226L20.424 14.5505L20.4237 14.5508C20.4022 14.576 20.381 14.6009 20.36 14.6254C19.9248 15.1339 19.6124 15.499 19.4702 15.9563L19.47 15.9567C19.3282 16.414 19.3754 16.8976 19.4419 17.5801C19.4449 17.6109 19.4479 17.6422 19.451 17.6739L19.451 17.6742L19.5197 18.379L10.6853 6.23481Z"
              fill="white"
              stroke="#1973C8"
            />
          </svg>
        </IconButton>
      </Skeleton>
    );

  return (
    <>
      <IconButton
        onClick={handleClick}
        color="primary"
        sx={{
          borderWidth: 1,
          borderStyle: "solid",
          borderColor: (theme) => theme.palette.primary.main,
        }}
      >
        {isFavorite ? (
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M9.15299 5.408C10.42 3.136 11.053 2 12 2C12.947 2 13.58 3.136 14.847 5.408L15.175 5.996C15.535 6.642 15.715 6.965 15.995 7.178C16.275 7.391 16.625 7.47 17.325 7.628L17.961 7.772C20.421 8.329 21.65 8.607 21.943 9.548C22.235 10.488 21.397 11.469 19.72 13.43L19.286 13.937C18.81 14.494 18.571 14.773 18.464 15.117C18.357 15.462 18.393 15.834 18.465 16.577L18.531 17.254C18.784 19.871 18.911 21.179 18.145 21.76C17.379 22.342 16.227 21.811 13.925 20.751L13.328 20.477C12.674 20.175 12.347 20.025 12 20.025C11.653 20.025 11.326 20.175 10.671 20.477L10.076 20.751C7.77299 21.811 6.62099 22.341 5.85599 21.761C5.08899 21.179 5.21599 19.871 5.46899 17.254L5.53499 16.578C5.60699 15.834 5.64299 15.462 5.53499 15.118C5.42899 14.773 5.18999 14.494 4.71399 13.938L4.27999 13.43C2.60299 11.47 1.76499 10.489 2.05699 9.548C2.34999 8.607 3.57999 8.328 6.03999 7.772L6.67599 7.628C7.37499 7.47 7.72399 7.391 8.00499 7.178C8.28499 6.965 8.46499 6.642 8.82499 5.996L9.15299 5.408Z"
              fill="#FFC900"
            />
          </svg>
        ) : (
          <svg
            width="20"
            height="20"
            viewBox="0 0 26 26"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M10.6853 6.23481L10.6853 6.23486L10.3437 6.84718C10.3275 6.87628 10.3115 6.905 10.2958 6.93334C9.96807 7.52226 9.73192 7.94666 9.35554 8.23298L9.35486 8.2335C8.97414 8.52208 8.50864 8.62697 7.87093 8.77067C7.84063 8.7775 7.80994 8.78441 7.77885 8.79144C7.7788 8.79145 7.77874 8.79147 7.77868 8.79148L7.11635 8.94144L7.11617 8.94148C5.81803 9.23488 4.90268 9.4435 4.26835 9.69356C3.64362 9.93983 3.42018 10.1772 3.33446 10.4522C3.24749 10.7327 3.29794 11.0721 3.66881 11.6613C4.04315 12.256 4.66842 12.9892 5.55252 14.0225L5.55276 14.0228L6.00451 14.5515C6.00462 14.5517 6.00473 14.5518 6.00484 14.5519C6.00484 14.5519 6.00485 14.5519 6.00485 14.5519C6.02561 14.5762 6.0461 14.6001 6.06634 14.6237C6.50208 15.132 6.81572 15.4979 6.95736 15.9574C7.10029 16.4139 7.05316 16.8981 6.98683 17.5796C6.98378 17.611 6.98069 17.6427 6.97757 17.6749L6.97753 17.6753L6.90883 18.379C6.90882 18.3791 6.90881 18.3792 6.9088 18.3793C6.77548 19.7583 6.68189 20.7377 6.71378 21.4509C6.74562 22.163 6.89851 22.4619 7.11651 22.6273C7.32511 22.7854 7.6261 22.8452 8.27362 22.6596C8.92742 22.4722 9.78564 22.0788 11.001 21.5194C11.001 21.5194 11.001 21.5194 11.0011 21.5194L11.6205 21.2341C11.6489 21.221 11.6769 21.2081 11.7046 21.1953C12.3021 20.9194 12.7396 20.7173 13.2143 20.7173C13.6896 20.7173 14.1274 20.9198 14.7251 21.1963C14.7521 21.2087 14.7793 21.2213 14.8069 21.2341C14.807 21.2341 14.8071 21.2342 14.8072 21.2342L15.428 21.5191L15.4286 21.5194C16.6436 22.0789 17.5014 22.4725 18.1552 22.6599C18.8025 22.8454 19.1036 22.7854 19.3128 22.6265L19.3132 22.6262C19.5304 22.4615 19.6832 22.1631 19.7149 21.4508C19.7467 20.7378 19.6531 19.7583 19.5198 18.3794L10.6853 6.23481ZM10.6853 6.23481C11.3534 5.03682 11.8278 4.18854 12.2534 3.63279C12.6788 3.07741 12.9608 2.94128 13.2143 2.94128C13.4677 2.94128 13.7498 3.07741 14.1751 3.63279C14.6007 4.18854 15.0751 5.03682 15.7432 6.23481L15.7432 6.23486L16.0848 6.84718C16.0848 6.84724 16.0849 6.8473 16.0849 6.84736C16.1011 6.8764 16.117 6.90506 16.1328 6.93334C16.4605 7.52226 16.6966 7.94666 17.073 8.23298C17.4528 8.52191 17.9197 8.62695 18.557 8.77033C18.5878 8.77727 18.6191 8.7843 18.6507 8.79144C18.6508 8.79144 18.6508 8.79145 18.6508 8.79145C18.6509 8.79147 18.651 8.79149 18.6511 8.79151L19.3132 8.94144C20.6115 9.2354 21.5266 9.44399 22.1607 9.69395C22.7851 9.94007 23.0083 10.1771 23.0941 10.4521C23.181 10.732 23.1308 11.071 22.7597 11.6605C22.3854 12.2553 21.7601 12.9887 20.8759 14.0226L20.424 14.5505L20.4237 14.5508C20.4022 14.576 20.381 14.6009 20.36 14.6254C19.9248 15.1339 19.6124 15.499 19.4702 15.9563L19.47 15.9567C19.3282 16.414 19.3754 16.8976 19.4419 17.5801C19.4449 17.6109 19.4479 17.6422 19.451 17.6739L19.451 17.6742L19.5197 18.379L10.6853 6.23481Z"
              fill="white"
              stroke="#1973C8"
            />
          </svg>
        )}
      </IconButton>
      <Popover
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleClose}
        anchorOrigin={{
          vertical: "bottom",
          horizontal: "center",
        }}
        transformOrigin={{
          vertical: "top",
          horizontal: "right",
        }}
      >
        <Box paddingY={1} paddingX={2}>
          <Typography component="h4" variant="h6">
            ¿Cuántas le pondrías?
          </Typography>
          <Rating
            onChange={async (_event, value) => {
              await handleValue(value);
            }}
            defaultValue={stars}
            icon={
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9.15299 5.408C10.42 3.136 11.053 2 12 2C12.947 2 13.58 3.136 14.847 5.408L15.175 5.996C15.535 6.642 15.715 6.965 15.995 7.178C16.275 7.391 16.625 7.47 17.325 7.628L17.961 7.772C20.421 8.329 21.65 8.607 21.943 9.548C22.235 10.488 21.397 11.469 19.72 13.43L19.286 13.937C18.81 14.494 18.571 14.773 18.464 15.117C18.357 15.462 18.393 15.834 18.465 16.577L18.531 17.254C18.784 19.871 18.911 21.179 18.145 21.76C17.379 22.342 16.227 21.811 13.925 20.751L13.328 20.477C12.674 20.175 12.347 20.025 12 20.025C11.653 20.025 11.326 20.175 10.671 20.477L10.076 20.751C7.77299 21.811 6.62099 22.341 5.85599 21.761C5.08899 21.179 5.21599 19.871 5.46899 17.254L5.53499 16.578C5.60699 15.834 5.64299 15.462 5.53499 15.118C5.42899 14.773 5.18999 14.494 4.71399 13.938L4.27999 13.43C2.60299 11.47 1.76499 10.489 2.05699 9.548C2.34999 8.607 3.57999 8.328 6.03999 7.772L6.67599 7.628C7.37499 7.47 7.72399 7.391 8.00499 7.178C8.28499 6.965 8.46499 6.642 8.82499 5.996L9.15299 5.408Z"
                  fill="#FFC900"
                />
              </svg>
            }
            emptyIcon={
              <svg
                width="26"
                height="26"
                viewBox="0 0 26 26"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.6853 6.23481L10.6853 6.23486L10.3437 6.84718C10.3275 6.87628 10.3115 6.905 10.2958 6.93334C9.96807 7.52226 9.73192 7.94666 9.35554 8.23298L9.35486 8.2335C8.97414 8.52208 8.50864 8.62697 7.87093 8.77067C7.84063 8.7775 7.80994 8.78441 7.77885 8.79144C7.7788 8.79145 7.77874 8.79147 7.77868 8.79148L7.11635 8.94144L7.11617 8.94148C5.81803 9.23488 4.90268 9.4435 4.26835 9.69356C3.64362 9.93983 3.42018 10.1772 3.33446 10.4522C3.24749 10.7327 3.29794 11.0721 3.66881 11.6613C4.04315 12.256 4.66842 12.9892 5.55252 14.0225L5.55276 14.0228L6.00451 14.5515C6.00462 14.5517 6.00473 14.5518 6.00484 14.5519C6.00484 14.5519 6.00485 14.5519 6.00485 14.5519C6.02561 14.5762 6.0461 14.6001 6.06634 14.6237C6.50208 15.132 6.81572 15.4979 6.95736 15.9574C7.10029 16.4139 7.05316 16.8981 6.98683 17.5796C6.98378 17.611 6.98069 17.6427 6.97757 17.6749L6.97753 17.6753L6.90883 18.379C6.90882 18.3791 6.90881 18.3792 6.9088 18.3793C6.77548 19.7583 6.68189 20.7377 6.71378 21.4509C6.74562 22.163 6.89851 22.4619 7.11651 22.6273C7.32511 22.7854 7.6261 22.8452 8.27362 22.6596C8.92742 22.4722 9.78564 22.0788 11.001 21.5194C11.001 21.5194 11.001 21.5194 11.0011 21.5194L11.6205 21.2341C11.6489 21.221 11.6769 21.2081 11.7046 21.1953C12.3021 20.9194 12.7396 20.7173 13.2143 20.7173C13.6896 20.7173 14.1274 20.9198 14.7251 21.1963C14.7521 21.2087 14.7793 21.2213 14.8069 21.2341C14.807 21.2341 14.8071 21.2342 14.8072 21.2342L15.428 21.5191L15.4286 21.5194C16.6436 22.0789 17.5014 22.4725 18.1552 22.6599C18.8025 22.8454 19.1036 22.7854 19.3128 22.6265L19.3132 22.6262C19.5304 22.4615 19.6832 22.1631 19.7149 21.4508C19.7467 20.7378 19.6531 19.7583 19.5198 18.3794L10.6853 6.23481ZM10.6853 6.23481C11.3534 5.03682 11.8278 4.18854 12.2534 3.63279C12.6788 3.07741 12.9608 2.94128 13.2143 2.94128C13.4677 2.94128 13.7498 3.07741 14.1751 3.63279C14.6007 4.18854 15.0751 5.03682 15.7432 6.23481L15.7432 6.23486L16.0848 6.84718C16.0848 6.84724 16.0849 6.8473 16.0849 6.84736C16.1011 6.8764 16.117 6.90506 16.1328 6.93334C16.4605 7.52226 16.6966 7.94666 17.073 8.23298C17.4528 8.52191 17.9197 8.62695 18.557 8.77033C18.5878 8.77727 18.6191 8.7843 18.6507 8.79144C18.6508 8.79144 18.6508 8.79145 18.6508 8.79145C18.6509 8.79147 18.651 8.79149 18.6511 8.79151L19.3132 8.94144C20.6115 9.2354 21.5266 9.44399 22.1607 9.69395C22.7851 9.94007 23.0083 10.1771 23.0941 10.4521C23.181 10.732 23.1308 11.071 22.7597 11.6605C22.3854 12.2553 21.7601 12.9887 20.8759 14.0226L20.424 14.5505L20.4237 14.5508C20.4022 14.576 20.381 14.6009 20.36 14.6254C19.9248 15.1339 19.6124 15.499 19.4702 15.9563L19.47 15.9567C19.3282 16.414 19.3754 16.8976 19.4419 17.5801C19.4449 17.6109 19.4479 17.6422 19.451 17.6739L19.451 17.6742L19.5197 18.379L10.6853 6.23481Z"
                  fill="white"
                  stroke="#1973C8"
                />
              </svg>
            }
            max={5}
          />
        </Box>
      </Popover>
    </>
  );
}
